# Описание работы игры

Игра сделана по туториалу https://unity3d.com/ru/learn/tutorials/s/2d-roguelike-tutorial. Все объекты, кроме стен - квадратные спрайты 32х32 (взяты из туториала, немного переделаны). Стены - тонкие прямоугольники, коллайдер подогнан автоматически под размер. Игра собрана для html. Управление: ходить на стрелочки, использовать туннель на пробел, использовать бомбы - стрелочки при нажатом Z.

### Что было реализовано (поэтапно):
- Алгоритм генерации лабиринта в виде матрицы. Алгоритм для лабиринта берем сразу так, чтобы можно было генерить его любого размера. Выбран алгоритм Эллера, который можно улучшать через DSU, но для маленьких лабиринтов это совсем неактуально. И вообще генерация карты происходит достаточно кастомизированно - можно указать размеры лабиринта, количество объектов и т.д. Все взаимодействия с непосредственно изменениями лабиринта производит MapManager.
- Инициализация пола и стен
- Генерация реки. Река генерится тупым перебором: задаются рамки минимальной и максимальной длины, затем от рандомной точки в лабиринте пытаемся ходить в рандомные стороны и прокладывать туда реку. Если уперлись в тупик, а длина меньше минимальной - стираем все и пробуем заново. 
- Генерация туннелей. На этом этапе стало понятно, что объекты реки и цепочки туннелей действуют похожим образом: оба по сути являются односвязными списками, поэтому было решено навесить на оба Prefab’а скрипт для хранения ссылки на следующий элемент. 
- Генерация арсенала и клада. Инициализация всех айтемов.На игрока навешиваем rigidbody2d, на все объекты, кроме пола - boxCollider2d (на стены polygonCollider2d). Вообще для взаимодействия игрока с предметами было два выхода: сопоставлять координаты игрока с матричным лабиринтом и по матрице проверять, на что мы натолкнулись, или же навесить на все коллайдеры и обрабатывать именно столкновения в зависимости от тега объекта. Выбран второй вариант, так как выглядит веселее. Кроме заведения разных тегов все объекты былираспределены по разным слоям: blocking (стены и выход) и environment(река, туннели, предметы для подбирания)
- Обработка перемещений. Обработка перемещений по нажатию стрелок - очевидно, передвигаем только в одну сторону, даже если нажато больше одной кнопки. При этом на все время передвижения лочим обработку нажатий вовсе. Плавное движение взято из туториала, но принцип понятен - просто задаем время, за которое игрок должен передвинуться на одну клетку, а потом в цикле рассчитываем, на сколько надо передвинуться. Для понимания того, в какой объект потенциально может врезаться игрок, до начала движения используется raycast2d и размещение объектов на разных слоях
- Обработка подбирания предметов. Все просто - в OnTriggerEnter нужный тег вызывает нужную функцию обработки, которая деактивирует предмет столкновения.
- Обработка врезаний в стену.
- Обработка вхождения в реку. Дополнительное движение при вхождении в реку, для чего заведен отдельный флаг, показывающий, находимся ли мы в реке.
- Обработка вхождения в туннель. То же, что и с рекой, только дополнительные флаги не нужны и перемещение в следующий тоннель мгновенное, а не плавное.
- Обработка использования туннеля по нажатию на кнопку.
- Обработка выхода из лабиринта. Не придумала ничего лучше, чем сделать еще один Prefab с коллайдером, который раскидать вокруг лабиринта и тоже проверять на взаимодействие.
- Обработка применения бомб. При применении бомбы в сторону, где нет стены не происходит вообще ничего. Иначе стена деактивируется, а на ее месте инициализируется разрушенная стена без коллайдера, чтобы просто было видно, где применялись бомбы.
- Сделать айтемы невидимыми, пока игрок на них не наткнется. Для простоты на предметы накидан скрипт Item, который инициализирует их невидимыми и делает невидимыми каждый раз на OnTriggerExit с игроком.
- Навешивание текста с информацией (врезание в стену, подбор бомб, подбор клада), количеством бомб и количеством сделанных ходов.
- Перезагрузка уровня. Игра по сути сейчас бесконечная, каждый уровень просто генерит лабиринт заново. Навешена картинка с номером уровня и следится, чтобы GameManager был всегда один. Оказалось, например, что при перезагрузке уровня пытается создаться еще один экземпляр, который при этом нормально убивается из Awake и не плодит лабиринты только при использовании DestroyImmediate, а не при Destroy, что  было неожиданно, особенно учитывая, что в туториале все было гладко и так.

###Что можно улучшить/реализовать/что не получилось
- Лабиринт с этим алгоритмом выглядит так себе, не особо запутанный. Плюс, проскакивают баги при генерации, которые сложно отловить в виду рандомности
- Нормальный подгон расположения камеры относительно центра лабиринта в зависимости от его размера. Пока делаем такой лабиринт, чтобы полностью умещаться в сцене и регулируем камеру вручную. Возможное улучшение: для больших лабиринтов ставим центр камеры или на игроке, или где-то возле, если игрок прям у центра лабиринта, а потом перемещаем ее вместе с игроком. Или же делаем так, чтобы лабиринт всегда полностью умещался в сцене независимо от размера
- Нужны нормальные экраны начала игры, выхода из нее и т.д.
- Выглядит все оч плохо, я вообще не рисую, пришлось брать готовые ассеты. Мало того, стены получаются без угловых элементов. Как это поправить, не особо понятно
- Для красоты еще не хватает анимации. Типа применения бомб.
- Из-за кучи разных условий для игры и общей говнокодовости итогого скрипта с обработкой перемещений, расплодилось много всяких флагов, в которых легко запутаться и налажать при введении дополнительных условий. Еще и приходилось постоянно выключать-включать коллайдеры, чтобы не натыкаться на то, на чем и так стоишь
- Из-за того, что предметы становятся невидимыми сами, а не обрабатываются нормально в скрипте игрока, при попытке пройти в стену, стоя на объекте (реке, например), выключается коллайдер объекта (см. выше), что автоматически делает его невидимым. То есть пока обрабатывается попытка биться головой об стену, предмет под ногами игрока мелькает, что не оч красиво
- Самое главное: вообще не адаптировано под мобилки. И если обработку свайпов для перемещения я еще худо-бедно себе представляю, то как делать кнопочки для тача (вместо пробела и Z) и обработку мультикасаний, я вообще без понятия, а чтобы нормально разобраться еще нужно немало времени
- Мне кажется, некоторые отдельные пункты (типа генерации реки или обработку выхода из лабиринта) можно реализовать гораздо эффективнее или красивее